K8s
=====

k8s란?
-----

쿠버네티스(k8s)는 컨테이너화된 애플리케이션의 배포, 관리 및 확장을 예약, 자동화 하기 위한 컨테이너 오케스트레이션 플랫폼이다. 

오늘날 많은 도커 컨테이너를 관리하기 위해 만들어짐

기능

1. 배포

2. 롤아웃

3. 서비스 검색

4. 스토리지 프로비저닝

5. 로드 밸런싱

6. 오토 스케일링

7. 자가 치료

Cluster
-------

클러스터는 컨테이너화된 애플리케이션을 실행하는 노드들의 집합임.

1. 컨트롤 플레인 ( Master Node )

2. 노드        ( Worker Node )

   
![image](https://github.com/user-attachments/assets/a6f9665a-b424-4650-a351-c433e0739f61)

컨트롤 플레인은 보통 1개에서 n개로 존재 ( 홀수개 ) 

컨트롤 플레인은 클러스터의 상태 관리, 명령어를 처리하는 역할을 함

etcd, controller-manager, scheduler, kube api server라고 하는 여러 컴포넌트로 이루어짐

kubectl은 kube api server와 커뮤니케이션하는 역할을 함.

마치 전통적인 3 tier 아키텍쳐 관계처럼, 클라이언트 - 백엔드 서버 - 데이터 서버의 역할을 하는 방식으로 마스터 노드가 돌아간다고 볼 수 있다.

클라이언트의 요청을 처리하는 API 서버가 있고, 그 API가 클러스터의 상태 데이터를 저장하는 데 활용하는 db가 있다. 

(scheduler, controller-manager가 클라이언트, kube api server가 백엔드, etcd가 데이터 서버에 해당된다고 볼 수 있다.)


컴포넌트 분석
----------

**Scheduler**

Api 서버와 통신하는 컴포넌트로써 각각의 노드( Worker Node )의 자원 ( cpu, memory, gpu 등 ) 사용 상태를 관리한다. 

동시에 아직 노드가 배정되지 않은 새로 생성된 pod를 감지하고 새로운 워크로드를 띄우는 역할을 함. 

클러스터 내 자원할당이 가능한 노드중 알맞은 노드를 선택하여 해당 노드에 워크로드를 배포하는( Pod을 띄우는 ) 역할을 한다



**Controller-manager**

여러 컨트롤러 프로세스를 관리한다.



두가지로 나뉨 ( Kube 컨트롤러 매니저, Cloud 컨트롤러 매니저 )



Cloud 컨트롤러 매니저는 대표적인 클라우드 공급자들 ( AWS, GCP, AZURE )과 통신
각각의 클라우드 환경에 맞춘 컨트롤러가 배정되어, 공급자들의 종속적인 기능등을 클러스터에서 수행


Kube 컨트롤러 매니저도 여러 컨트롤러로 이루어져 있다. Api서버에는 다양한 Api 리소스들 (Pod, Deployment, service, secret등 )이 있고, 
각각의 리소스들을 관리하는 컨트롤러가 배정된다. 이들은 Api 서버를 주기적으로 찌르면서 현재 클러스터  상태와, etcd에 저장된 리소스의
상태를 비교한다. 만약 etcd 리소스 상태에 변화가 있다면, 이를 현재 클러스터 리소스에 반영함으로써 동기화 시켜준다.
이러한 변화를 동기화시키는 반복된 과정을 reconcile이라고 부름


**Kube api Server**

쿠버네티스 리소스와 클러스터의 상태 관리 및 동기화를 위한 API를 제공

etcd를 데이터 저장소로 사용

**etcd**

분산 key-value 저장소로 클러스터의 상태를 저장한다.

만약 클러스터 상태를 백업하고 복구하고 싶다면 etcd를 건드리면 됨

컨트롤 플레인 밖에 따로 떼서 관리하기도 하지만, 일반적으로 컨트롤 플레인 내부에 각각 할당됨.

워커노드
------

애플리케이션이 실질적으로 실행되는 ( 컨테이너가 띄워지는 ) 공간에 위치한다. 노드는 최소 1개 ~ n개로 구성된다.

내부에 존재하는 컴포넌트 구성도 모든 노드가 동일하다.

Container Runtime 위에서 Pod가 실행되는게 기본 형태이다. 그외에 System 컴포넌트들이라 할 수 있는

Kubelet, Kube-proxy, network-addOn과 같은 여러 컴포넌트들도 돌아간다.

**Kubelet**

모든 노드에 기본적으로 설치되는 컴포넌트 

Api 서버와 통신하며 노드의 리소스 상태를 보고하고 관리한다.

Container Runtimes과도 통신하며, 해당 노드 내에 띄워지는 컨테이너 라이프사이클을 관리하기도 함

**CRI(Container Runtime Interface)**

kubelet이 다양한 컨테이너 런타임과 통신할 수 있도록 쿠버네티스가 자체적으로 준비한 인터페이스

컨테이너를 관리해주는게 Docker만 있는 게 아니기 때문에, 오히려 docker에 대한 의존성을 줄이기 위함

모든 CRI 구현체들을 지원하며, kubelet과 통신할 수 있게 된다.

**kube-proxy**

이 컴포넌트는 우선 클러스터 상에 오버레이 네트워크를 구성

내부적으로 네트워크 프록시 및 내부 로드밸런서 역할을 함 



